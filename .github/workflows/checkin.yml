name: checkin

on:
  schedule:
    - cron: '2 1 * * *'
  
  # 允许手动触发
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    
    steps:
    # 检出代码
    - name: 检出代码
      uses: actions/checkout@v4
    
    # 设置 Python 环境
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # 安装依赖
    - name: 安装依赖
      run: |
        pip install requests pyyaml
    
    # 运行
    - name: 执行checkin
      env:
        M_COOKIE_Rua: ${{ secrets.M_COOKIE_RUA }}
        M_Stoken_Rua: ${{ secrets.M_STOKEN_RUA }}
        M_COOKIE_Cris: ${{ secrets.M_COOKIE_CRIS }}
        M_Stoken_Cris: ${{ secrets.M_STOKEN_CRIS }}
        M_COOKIE_185: ${{ secrets.M_COOKIE_185 }}
        M_COOKIE_Abi: ${{ secrets.M_COOKIE_ABI }}
        M_COOKIE_Jia: ${{ secrets.M_COOKIE_JIA }}
      run: |
        # 安装 envsubst
        sudo apt-get update && sudo apt-get install -y gettext
        
        # 替换所有 yaml 文件
        for file in m-BBS/config/*.yaml m-BBS/config/*.yml; do
          [ -e "$file" ] || continue
          echo "处理: $file"
          envsubst < "$file" > "${file}.tmp"
          mv "${file}.tmp" "$file"
        done
        
        echo "✅ 配置文件已更新"
    
    # ========== 运行步骤（不需要 env，因为值已在 yaml 里）==========
    - name: 执行checkin
      env:
        AutoMihoyoBBS_autorun: "1"
      run: |
        python m-BBS/main_multi.py
